name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
          - mpc-node
      skip_terraform:
        description: 'Skip Terraform apply'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-northeast-1
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
  SERVICE: ${{ github.event.inputs.service || 'all' }}

permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_terraform != 'true' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Setup SOPS
        uses: mdgreenwald/mozilla-sops-action@v1.6.0

      - name: Terraform Init
        working-directory: terraform/environments/${{ env.ENVIRONMENT }}
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform/environments/${{ env.ENVIRONMENT }}
        run: terraform apply -auto-approve

  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    needs: [terraform]
    if: always() && (needs.terraform.result == 'success' || needs.terraform.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Setup SOPS
        uses: mdgreenwald/mozilla-sops-action@v1.6.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push to ECR
        run: ./scripts/deploy-to-ecr.sh ${{ env.ENVIRONMENT }} ${{ env.SERVICE }}

  update-ecs:
    name: Update ECS Services
    runs-on: ubuntu-latest
    needs: [build-and-push]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.0
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_wrapper: false

      - name: Setup SOPS
        uses: mdgreenwald/mozilla-sops-action@v1.6.0

      - name: Update ECS Services
        run: ./scripts/update-ecs-service.sh ${{ env.ENVIRONMENT }} ${{ env.SERVICE }} --wait
